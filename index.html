<html>
<head>
    <script src="http://code.createjs.com/preloadjs-0.6.0.min.js"></script>
    <script src="http://code.createjs.com/easeljs-0.8.0.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>

    var key = {
        UP:    38,
        DOWN:  40,
        LEFT:  37,
        RIGHT: 39,
        SPACE: 32
    };
    var preload = null;
    var stage = null, map = null, plane = null;

    var fps = 35;
    var mapWidth = 640, mapHeight = 640;
    var width = 570, height = 570;
    var baseMapUri = "http://maps.googleapis.com/maps/api/staticmap?size=" + mapWidth + "x" + mapHeight;
    var mapOffset = {
        x:-35, y:-35
    };

    var lat = 48.16500, lon = 16.39496;
    var zoom = 16;

    var tick = 0;

    function initPlayground() {
        preload = new createjs.LoadQueue(true);
        preload.on("fileload", handleFileLoaded, this);
        preload.on("error", handleFileError, this);
        stage = new createjs.Stage("playground");

        plane = new createjs.Bitmap("assets/drone-50-41.png");
        plane.x = width/2 - 25; // width/2 - planewidth/2
        plane.y = height/2 - 20; // height/2 - planeheight/2
        stage.addChild(plane);

        createjs.Ticker.setFPS(fps);
        createjs.Ticker.addEventListener("tick", handleTick);
    }

    function handleTick() {
        tick++;
        //if(tick % fps == 0) {
        if(tick == 1) {
            tick = 1;
            lat += 0.00050;
            var mapUri = baseMapUri + "&center=" + lat + "," + lon + "&zoom=" + zoom;
            console.log(mapUri);
            preload.loadFile({id:"map", src:mapUri, type:createjs.AbstractLoader.IMAGE});
        } 
        if(map) {
        /*
            map.y += 1;
            var rect;
            if(map.sourceRect) {
                rect = new createjs.Rectangle(0, 0, width, map.sourceRect.height-1);
                
            } else {
                rect = new createjs.Rectangle(0, 0, width, height);
            }
            map.sourceRect = rect;
        */
            stage.update();
        }

    }

    function handleFileLoaded(event) {
        var item = event.item;
        if(item.id === "map" && item.type == createjs.LoadQueue.IMAGE) {
            if(map) {
                stage.removeChild(map);
            }
            map = new createjs.Bitmap(event.result);
            map.regX = mapWidth/2;
            map.regY = mapHeight/2;
            map.rotation = 0;
            map.x = mapWidth/2 + mapOffset.x;
            map.y = mapHeight/2 + mapOffset.y;
            stage.addChildAt(map, stage.getChildIndex(plane));
        }
    }

    function handleFileError(event) {
        console.log("+++ file load error");
    }

    function rotate(deg) {
        if(!map) {
            return;
        }

        map.rotation = (map.rotation % 360) + deg;
        console.log("current rotation is " + map.rotation);
    }

    $( document ).ready(function() {
        initPlayground();

        $(document).keydown(function(event) {
            switch(event.which) {
                case key.UP:
                    console.log("UP");
                    event.preventDefault();
                    break;
                case key.DOWN:
                    console.log("DOWN");
                    event.preventDefault();
                    break;
                case key.LEFT:
                    console.log("LEFT");
                    rotate(5);
                    event.preventDefault();
                    break;
                case key.RIGHT:
                    console.log("RIGHT");
                    rotate(-5);
                    event.preventDefault();
                    break;
                case key.SPACE:
                    console.log("SPACE");
                    event.preventDefault();
                    break;
            }
        });
    });
    </script>
</head>
<body>
    <canvas id="playground" width="640" height="640"></canvas>
</body>
</html>
